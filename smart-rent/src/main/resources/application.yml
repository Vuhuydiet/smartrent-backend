server:
  port: 8080
  # Tomcat configuration for large file uploads (videos)
  tomcat:
    connection-timeout: 300000  # 5 minutes for video uploads
    max-http-form-post-size: 110MB
    max-swallow-size: 110MB
  error:
    # Disable Spring Boot's default error page to ensure @ControllerAdvice handles all exceptions
    whitelabel:
      enabled: false
    # Don't include exception details in error responses
    include-exception: false
    include-stacktrace: never
    include-message: always

# Logging Configuration
logging:
  level:
    root: INFO
    # Application-wide logging
    com.smartrent: INFO
    # Service-specific logging levels
    com.smartrent.service.authentication: INFO
    com.smartrent.service.user: INFO
    com.smartrent.service.admin: INFO
    com.smartrent.service.email: INFO
    com.smartrent.service.role: INFO
    com.smartrent.service.listing: INFO
    com.smartrent.service.payment: INFO
    com.smartrent.service.vnpay: INFO
    com.smartrent.service.analytics: INFO
    com.smartrent.service.communication: INFO
    com.smartrent.service.content: INFO
    com.smartrent.service.discovery: INFO
    com.smartrent.service.phoneclickdetail: INFO
    # Framework logging
    org.springframework: WARN
    org.hibernate: WARN
    org.hibernate.SQL: ERROR
    org.hibernate.type.descriptor.sql.BasicBinder: ERROR
    com.zaxxer.hikari: WARN
    org.flywaydb: INFO
    feign: INFO
    io.github.resilience4j: INFO
    org.springframework.web: WARN
    org.springframework.security: WARN
    org.springframework.boot.actuate: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/smart-rent.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

spring:
  application:
    name: smart-rent
  cloud:
    compatibility-verifier:
      enabled: false
  # Multipart file upload configuration for video/image uploads
  servlet:
    multipart:
      enabled: true
      max-file-size: 100MB      # Maximum file size per file
      max-request-size: 110MB   # Maximum total request size
      file-size-threshold: 2MB  # Threshold after which files are written to disk
  datasource:
    driverClassName: com.mysql.cj.jdbc.Driver
    url: ${IDENTITY_SERVICE_DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  flyway:
    enabled: true
    out-of-order: true
    validate-on-migrate: false
    clean-on-validation-error: false
  jpa:
    database: MYSQL
    openInView: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        jdbc:
          batch_size: 25
          batch_versioned_data: true
          time_zone: UTC
        order_inserts: true
        order_updates: true
        show_sql: false
        connection:
          provider_disables_autocommit: false
          handling_mode: DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION
  data:
    redis:
      username: "${REDIS_USERNAME:}"
      password: "${REDIS_PWD:}"
      port: 6379
      host: "${REDIS_HOST:localhost}"
      repositories:
        enabled: true
      ssl:
        enabled: "${REDIS_SSL:false}"
      timeout: "${REDIS_TIMEOUT:10s}"
      connectTimeout: "${REDIS_CONNECTION_TIMEOUT:5s}"
      lettuce.pool:
        maxIdle: "${LETTUCE_MAX_IDLE:8}"
        minIdle: "${LETTUCE_MIN_IDLE:4}"
        maxActive: "${LETTUCE_MAX_ACTIVE:16}"
        maxWait: "${LETTUCE_MAX_WAIT:10s}"
  cache:
    cacheNames:
      - "user.details"
      - "auth.accessToken"
      - "auth.refreshToken"
      - "auth.otp"
      - "auth.invalidatedTokens"
      - "locationCache"
    type: "${CACHE_TYPE:redis}"
    redis:
      timeToLive: 1d
      expires:
        "[user.details]": 1m
        "[auth.otp]": 5m
        "[auth.invalidatedTokens]": 24h
        "[locationCache]": 24h

application:
  client-url: "https://smartrent-fe.vercel.app"
  cors:
    allowed-origins: "*"
  admin:
    contact-phone-number: "${ADMIN_CONTACT_PHONE}"
  authorize-ignored:
    methods:
      get:
        - "/error"
        - "/swagger-ui/**"
        - "/swagger-ui.html"
        - "/v3/api-docs/**"
        - "/v3/api-docs"
        - "/swagger-resources/**"
        - "/webjars/**"
        - "/actuator/health"
        - "/actuator/**"
        - "/v1/listings/**"                   # Public listings (except my-* and draft/* - checked in code)
        - "/v1/addresses/convert/**"
        - "/v1/addresses/**"
        - "/v1/new-addresses/**"
        - "/v1/memberships/packages"
        - "/v1/memberships/packages/**"
        - "/v1/vip-tiers/**"
        - "/v1/push-details/**"
        - "/v1/categories/**"
        - "/v1/support/contact"
        - "/v1/payments/callback/**"
      post:
        - "/v1/auth/**"
        - "/v1/users"
        - "/v1/admins"
        - "/v1/verification/**"
        - "/otp/**"
        - "/v1/listings/*/reports"
        - "/v1/listings/search"
        - "/v1/listings/stats/provinces"
        - "/v1/listings/stats/categories"
        - "/v1/listings/map-bounds"
  authentication:
    jwt:
      access-signer-key: "${ACCESS_SIGNER_KEY}"
      refresh-signer-key: "${REFRESH_SIGNER_KEY}"
      reset-password-signer-key: "${RESET_PASSWORD_SIGNER_KEY}"
      valid-duration: "${VALID_DURATION}"
      refreshable-duration: "${REFRESHABLE_DURATION}"
      reset_password_duration: "${RESET_PASSWORD_DURATION}"
  api-key:
    brevo: "${BREVO_API_KEY}"
  email:
    sender:
      email: "${SENDER_EMAIL}"
      name: "${SENDER_NAME:SmartRent}"
    subject: "SmartRent"
  otp:
    length: 6
    duration: 60 #s
  email-retry:
    max-attempts: 3
    base-wait-duration: 2000 # milliseconds
    exponential-multiplier: 2.0
    jitter-percentage: 0.25
    min-wait-duration: 1000 # milliseconds
  circuit-breaker:
    failure-rate-threshold: 60 # percentage
    wait-duration-in-open-state: 120 # seconds
    sliding-window-size: 20
    minimum-number-of-calls: 10
    permitted-calls-in-half-open: 5
    timeout-duration: 15 # seconds

# Google Maps API Configuration
google:
  maps:
    api-key: ${GOOGLE_API_KEY}
feign:
  client:
    config:
      brevo:
        url: "https://api.brevo.com"
      smartrent-ai:
        url: "${AI_SERVICE_BASE_URL:http://localhost:8000}"
        connectTimeout: 10000
        readTimeout: 30000
      google:
        auth:
          url: "https://oauth2.googleapis.com"
          client_id: ${CLIENT_ID}
          client_secret: ${CLIENT_SECRET}
          redirect_uri: ${GOOGLE_AUTH_CLIENT_REDIRECT_URI}
          grant_type: "authorization_code"
        client:
          url: "https://www.googleapis.com"
      vnpay:
        url: "${VNPAY_QUERY_URL:https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}"
      google-maps:
        url: "${GOOGLE_MAPS_API_URL:https://maps.googleapis.com/maps/api}"

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    enabled: true

open:
  api:
    title: "SmartRent API"
    version: "v1.0.0"
    description: "API for SmartRent Application"
    server:
      url: "https://dev.smartrent-api.vuhuydiet.xyz"
      description: "Local Server."
    group:
      package-to-scan: "com.smartrent.controller"
  # S3-compatible storage config (Cloudflare R2, DigitalOcean Spaces, AWS S3, etc.)
  storage:
    s3:
      endpoint: ${S3_ENDPOINT}
      region: ${S3_REGION:auto}
      accessKey: ${S3_ACCESS_KEY}
      secretKey: ${S3_SECRET_KEY}
      bucketName: ${S3_BUCKET}
      publicUrl: ${S3_PUBLIC_URL}
      maxFileSizeMB: ${S3_MAX_FILE_SIZE_MB:100}
      uploadUrlTtlMinutes: ${S3_UPLOAD_URL_TTL_MINUTES:30}
      downloadUrlTtlMinutes: ${S3_DOWNLOAD_URL_TTL_MINUTES:60}
      allowedImageTypes:
        - image/jpeg
        - image/png
        - image/webp
      allowedVideoTypes:
        - video/mp4
        - video/quicktime

# VNPay Payment Gateway Configuration
vnpay:
  tmn-code: ${VNPAY_TMN_CODE:DEMO}
  hash-secret: ${VNPAY_HASH_SECRET:DEMOSECRETKEY}
  payment-url: ${VNPAY_PAYMENT_URL:https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
  query-url: ${VNPAY_QUERY_URL:https://sandbox.vnpayment.vn/merchant_webapi/api/transaction}
  return-url: ${VNPAY_RETURN_URL:http://localhost:3000/payment/result}
  ipn-url: ${VNPAY_IPN_URL:http://localhost:8080/v1/payments/ipn/VNPAY}
  version: "2.1.0"
  command: "pay"
  currency-code: "VND"
  locale: "vn"
  order-type: "other"
  timeout-minutes: 15

# Resilience4j Configuration for Circuit Breaker and Retry patterns
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - feign.FeignException
          - java.lang.RuntimeException
    instances:
      emailService:
        baseConfig: default
        recordFailurePredicate: com.smartrent.config.retry.email.EmailServiceFailurePredicate

  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 1s
        exponentialBackoffMultiplier: 2.0
        enableExponentialBackoff: true
        retryExceptions:
          - feign.FeignException
        ignoreExceptions:
          - feign.FeignException$BadRequest
          - feign.FeignException$Unauthorized
          - feign.FeignException$Forbidden
    instances:
      emailService:
        baseConfig: default

  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
        cancelRunningFuture: true
    instances:
      emailService:
        baseConfig: default

# Management endpoints for monitoring circuit breaker health
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers,retries
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# OTP Phone Verification Configuration
otp:
  # OTP code configuration
  code-length: 6
  ttl-seconds: 300  # 5 minutes
  max-verification-attempts: 5

  # Storage configuration
  store:
    type: ${OTP_STORE_TYPE:redis}  # redis or memory (memory for testing only)

  # Rate limiting configuration
  rate-limit:
    max-sends-per-phone: 5      # Maximum OTP sends per phone in time window
    max-sends-per-ip: 20         # Maximum OTP sends per IP in time window
    window-seconds: 3600         # Time window in seconds (1 hour)

  # Provider configurations
  providers:
    # Zalo ZNS (primary channel)
    # IMPORTANT: Requires Zalo Official Account registration and template approval
    # See: https://developers.zalo.me/docs/zalo-notification-service
    zalo:
      enabled: ${ZALO_OTP_ENABLED:false}
      access-token: ${ZALO_ACCESS_TOKEN:}
      oa-id: ${ZALO_OA_ID:}
      template-id: ${ZALO_TEMPLATE_ID:}
      api-endpoint: ${ZALO_API_ENDPOINT:https://business.openapi.zalo.me/message/template}
      max-retry-attempts: ${ZALO_MAX_RETRY_ATTEMPTS:3}
      retry-backoff-seconds: ${ZALO_RETRY_BACKOFF_SECONDS:1}
      request-timeout-seconds: ${ZALO_REQUEST_TIMEOUT_SECONDS:10}
      app-name: ${ZALO_APP_NAME:SmartRent}
      default-expiry-minutes: ${ZALO_DEFAULT_EXPIRY_MINUTES:5}

    # Twilio SMS (fallback channel)
    # IMPORTANT: SMS sender registration required in Vietnam
    # Consider using local SMS providers (VIETGUYS, VNPT, FPT, Viettel) for production
    twilio:
      enabled: ${TWILIO_OTP_ENABLED:false}
      account-sid: ${TWILIO_ACCOUNT_SID:}

# AI Service Configuration
smarrent:
  ai:
    verification:
      enabled: ${AI_VERIFICATION_ENABLED:true}
      url: ${AI_VERIFICATION_URL:http://localhost:8000/ai/verify-listing}
      timeout-seconds: ${AI_VERIFICATION_TIMEOUT:90}
      max-retry-attempts: ${AI_VERIFICATION_MAX_RETRY:3}
      retry-backoff-seconds: ${AI_VERIFICATION_RETRY_BACKOFF:2}
      auth-token: ${TWILIO_AUTH_TOKEN:}
      from-number: ${TWILIO_FROM_NUMBER:}
      message-template: "${TWILIO_MESSAGE_TEMPLATE:SmartRent - Your verification code is %s. Valid for 5 minutes. Do not share this code.}"