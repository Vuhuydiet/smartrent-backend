server:
  port: 8080

# Logging Configuration
logging:
  level:
    root: INFO
    # Application-wide logging
    com.smartrent: INFO
    # Service-specific logging levels
    com.smartrent.service.authentication: INFO
    com.smartrent.service.user: INFO
    com.smartrent.service.admin: INFO
    com.smartrent.service.email: INFO
    com.smartrent.service.role: INFO
    com.smartrent.service.listing: INFO
    com.smartrent.service.payment: INFO
    com.smartrent.service.vnpay: INFO
    com.smartrent.service.analytics: INFO
    com.smartrent.service.communication: INFO
    com.smartrent.service.content: INFO
    com.smartrent.service.discovery: INFO
    # Framework logging
    org.springframework: WARN
    org.hibernate: WARN
    org.hibernate.SQL: ERROR
    org.hibernate.type.descriptor.sql.BasicBinder: ERROR
    com.zaxxer.hikari: WARN
    org.flywaydb: INFO
    feign: INFO
    io.github.resilience4j: INFO
    org.springframework.web: WARN
    org.springframework.security: WARN
    org.springframework.boot.actuate: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/smart-rent.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

spring:
  application:
    name: smart-rent
  datasource:
    driverClassName: com.mysql.cj.jdbc.Driver
    url: ${IDENTITY_SERVICE_DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  flyway:
    enabled: true
    out-of-order: true
  jpa:
    database: MYSQL
    openInView: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        jdbc:
          batch_size: 25
          batch_versioned_data: true
          time_zone: UTC
        order_inserts: true
        order_updates: true
        show_sql: false
        connection:
          provider_disables_autocommit: false
          handling_mode: DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION
  data:
    redis:
      username: "${REDIS_USERNAME:}"
      password: "${REDIS_PWD:}"
      port: 6379
      host: "${REDIS_HOST:localhost}"
      repositories:
        enabled: true
      ssl:
        enabled: "${REDIS_SSL:false}"
      timeout: "${REDIS_TIMEOUT:10s}"
      connectTimeout: "${REDIS_CONNECTION_TIMEOUT:5s}"
      lettuce.pool:
        maxIdle: "${LETTUCE_MAX_IDLE:8}"
        minIdle: "${LETTUCE_MIN_IDLE:4}"
        maxActive: "${LETTUCE_MAX_ACTIVE:16}"
        maxWait: "${LETTUCE_MAX_WAIT:10s}"
  cache:
    cacheNames:
      - "user.details"
      - "auth.accessToken"
      - "auth.refreshToken"
      - "auth.otp"
      - "auth.invalidatedTokens"
      - "locationCache"
    type: "${CACHE_TYPE:redis}"
    redis:
      timeToLive: 1d
      expires:
        "[user.details]": 1m
        "[auth.otp]": 5m
        "[auth.invalidatedTokens]": 24h
        "[locationCache]": 24h

application:
  client-url: "${CLIENT_URL:http://localhost:3000}"
  authorize-ignored:
    methods:
      get:
        - "/swagger-ui/**"
        - "/swagger-ui.html"
        - "/v3/api-docs/**"
        - "/v3/api-docs"
        - "/swagger-resources/**"
        - "/webjars/**"
        - "/actuator/health"
        - "/actuator/**"
        - "/v1/payments/vnpay/callback"
        - "/v1/listings/**"
        - "/v1/addresses/**"
        - "/v1/memberships/packages"
        - "/v1/memberships/packages/**"
      post:
        - "/v1/auth/**"
        - "/v1/users"
        - "/v1/admins"
        - "/v1/payments/vnpay/ipn"
  authentication:
    jwt:
      access-signer-key: "${ACCESS_SIGNER_KEY}"
      refresh-signer-key: "${REFRESH_SIGNER_KEY}"
      reset-password-signer-key: "${RESET_PASSWORD_SIGNER_KEY}"
      valid-duration: "${VALID_DURATION}"
      refreshable-duration: "${REFRESHABLE_DURATION}"
      reset_password_duration: "${RESET_PASSWORD_DURATION}"
  api-key:
    brevo: "${BREVO_API_KEY}"
  email:
    sender:
      email: "${SENDER_EMAIL}"
      name: "${SENDER_NAME:SmartRent}"
    subject: "SmartRent"
  otp:
    length: 6
    duration: 60 #s
  email-retry:
    max-attempts: 3
    base-wait-duration: 2000 # milliseconds
    exponential-multiplier: 2.0
    jitter-percentage: 0.25
    min-wait-duration: 1000 # milliseconds
  circuit-breaker:
    failure-rate-threshold: 60 # percentage
    wait-duration-in-open-state: 120 # seconds
    sliding-window-size: 20
    minimum-number-of-calls: 10
    permitted-calls-in-half-open: 5
    timeout-duration: 15 # seconds
feign:
  client:
    config:
      brevo:
        url: "https://api.brevo.com"
      google:
        auth:
          url: "https://oauth2.googleapis.com"
          client_id: ${CLIENT_ID}
          client_secret: ${CLIENT_SECRET}
          redirect_uri: ${GOOGLE_AUTH_CLIENT_REDIRECT_URI}
          grant_type: "authorization_code"
        client:
          url: "https://www.googleapis.com"
      vnpay:
        url: "${VNPAY_QUERY_URL:https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}"

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    enabled: true

open:
  api:
    title: "SmartRent API"
    version: "v1.0.0"
    description: "API for SmartRent Application"
    server:
      url: "http://localhost:8080"
      description: "Local Server."
    group:
      package-to-scan: "com.smartrent.controller"
  # S3-compatible storage config (Cloudflare R2, DigitalOcean Spaces, AWS S3, etc.)
  storage:
    s3:
      endpoint: ${S3_ENDPOINT}
      region: ${S3_REGION}
      accessKey: ${S3_ACCESS_KEY}
      secretKey: ${S3_SECRET_KEY}
      bucketName: ${S3_BUCKET}
      publicUrl: ${S3_PUBLIC_URL}
      maxFileSizeMB: ${S3_MAX_FILE_SIZE_MB:10}
      allowedImageTypes:
        - image/jpeg
        - image/png
        - image/webp
      allowedVideoTypes:
        - video/mp4
        - video/quicktime

# VNPay Payment Gateway Configuration
vnpay:
  tmnCode: ${VNPAY_TMN_CODE:DEMO}
  hashSecret: ${VNPAY_HASH_SECRET:DEMOSECRETKEY}
  url: ${VNPAY_URL:https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
  returnUrl: ${VNPAY_RETURN_URL:http://localhost:8080/v1/payments/callback}
  version: "2.1.0"
  command: "pay"
  currencyCode: "VND"
  locale: "vn"
  orderType: "other"
  timeout: 15

# Resilience4j Configuration for Circuit Breaker and Retry patterns
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - feign.FeignException
          - java.lang.RuntimeException
    instances:
      emailService:
        baseConfig: default
        recordFailurePredicate: com.smartrent.config.retry.email.EmailServiceFailurePredicate

  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 1s
        exponentialBackoffMultiplier: 2.0
        enableExponentialBackoff: true
        retryExceptions:
          - feign.FeignException
        ignoreExceptions:
          - feign.FeignException$BadRequest
          - feign.FeignException$Unauthorized
          - feign.FeignException$Forbidden
    instances:
      emailService:
        baseConfig: default

  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
        cancelRunningFuture: true
    instances:
      emailService:
        baseConfig: default

# Management endpoints for monitoring circuit breaker health
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers,retries
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true